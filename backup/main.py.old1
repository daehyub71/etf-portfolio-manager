# ==========================================
# main.py - ETF ì‹œìŠ¤í…œ í†µí•© ëŸ°ì²˜
# ==========================================

import sys
import os
import time
import argparse
from datetime import datetime

# í”„ë¡œì íŠ¸ ëª¨ë“ˆ import (ì˜¤ë¥˜ ì²˜ë¦¬ í¬í•¨)
modules_loaded = {}

# UpdateManager import ì‹œë„
try:
    from core.update_manager import UpdateManager
    modules_loaded['UpdateManager'] = True
    print("âœ… UpdateManager ëª¨ë“ˆ import ì„±ê³µ")
except ImportError:
    try:
        from core.update_manager import ETFUpdateManager as UpdateManager
        modules_loaded['UpdateManager'] = True
        print("âœ… ETFUpdateManager ëª¨ë“ˆ import ì„±ê³µ")
    except ImportError:
        modules_loaded['UpdateManager'] = False
        print("âš ï¸ UpdateManager ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        
        class DummyUpdateManager:
            """ë”ë¯¸ ì—…ë°ì´íŠ¸ ê´€ë¦¬ì"""
            def batch_update_all_etfs(self, max_etfs=None, delay_between_updates=1.0):
                print(f"ğŸ”„ ë”ë¯¸ ì—…ë°ì´íŠ¸ ì‹¤í–‰ (ìµœëŒ€ {max_etfs}ê°œ ETF)")
                time.sleep(2)  # ì‹œë®¬ë ˆì´ì…˜
                
                class Summary:
                    total_etfs = max_etfs or 100
                    successful_updates = int(0.8 * (max_etfs or 100))
                    failed_updates = int(0.2 * (max_etfs or 100))
                    success_rate = 80.0
                    total_duration = 2.0 * 60  # 2ë¶„
                
                return Summary()
            
            def get_system_status(self):
                return {
                    'total_etfs': 100,
                    'updated_etfs': 80,
                    'price_available': 75,
                    'recent_updates_24h': 50,
                    'health_score': 85.0,
                    'status': 'healthy'
                }
            
            def get_current_status(self):
                return {
                    'is_updating': False,
                    'progress': 100.0,
                    'last_update': '2024-12-22 18:00:00'
                }
            
            def get_update_history(self, limit=3):
                return [
                    {
                        'start_time': '2024-12-22 18:00:00',
                        'success_rate': 85.0,
                        'successful_updates': 85,
                        'total_etfs': 100
                    },
                    {
                        'start_time': '2024-12-21 18:00:00',
                        'success_rate': 90.0,
                        'successful_updates': 90,
                        'total_etfs': 100
                    }
                ]
        
        UpdateManager = DummyUpdateManager

# Scheduler import ì‹œë„
try:
    from core.scheduler import Scheduler
    modules_loaded['Scheduler'] = True
    print("âœ… Scheduler ëª¨ë“ˆ import ì„±ê³µ")
except ImportError:
    try:
        from core.scheduler import ETFScheduler as Scheduler
        modules_loaded['Scheduler'] = True
        print("âœ… ETFScheduler ëª¨ë“ˆ import ì„±ê³µ")
    except ImportError:
        modules_loaded['Scheduler'] = False
        print("âš ï¸ Scheduler ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
        
        class DummyScheduler:
            """ë”ë¯¸ ìŠ¤ì¼€ì¤„ëŸ¬"""
            def __init__(self):
                self.is_running = False
            
            def start(self):
                self.is_running = True
                print("ğŸš€ ë”ë¯¸ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘")
                return True
            
            def stop(self):
                self.is_running = False
                print("ğŸ›‘ ë”ë¯¸ ìŠ¤ì¼€ì¤„ëŸ¬ ì¤‘ì§€")
                return True
        
        Scheduler = DummyScheduler

# ETFUniverse import ì‹œë„
try:
    from data.etf_universe import ETFUniverse
    modules_loaded['ETFUniverse'] = True
    print("âœ… ETFUniverse ëª¨ë“ˆ import ì„±ê³µ")
except ImportError:
    modules_loaded['ETFUniverse'] = False
    print("âš ï¸ ETFUniverse ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
    
    class DummyETFUniverse:
        """ë”ë¯¸ ETF ìœ ë‹ˆë²„ìŠ¤"""
        def __init__(self):
            print("ğŸ“Š ë”ë¯¸ ETF ìœ ë‹ˆë²„ìŠ¤ ì´ˆê¸°í™”")
    
    ETFUniverse = DummyETFUniverse

# PortfolioManager import ì‹œë„
try:
    from core.portfolio_manager import PortfolioManager
    modules_loaded['PortfolioManager'] = True
    print("âœ… PortfolioManager ëª¨ë“ˆ import ì„±ê³µ")
except ImportError:
    modules_loaded['PortfolioManager'] = False
    print("âš ï¸ PortfolioManager ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
    
    class DummyPortfolioManager:
        """ë”ë¯¸ í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬ì"""
        def __init__(self, database_manager=None, **kwargs):
            self.db_manager = database_manager
            print("ğŸ’¼ ë”ë¯¸ í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬ì ì´ˆê¸°í™”")
            
        def set_database_manager(self, db_manager):
            self.db_manager = db_manager
    
    PortfolioManager = DummyPortfolioManager

# DatabaseManager import ì‹œë„
try:
    from data.database_manager import DatabaseManager
    modules_loaded['DatabaseManager'] = True
    print("âœ… DatabaseManager ëª¨ë“ˆ import ì„±ê³µ")
except ImportError:
    modules_loaded['DatabaseManager'] = False
    print("âš ï¸ DatabaseManager ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
    
    class DummyDatabaseManager:
        """ë”ë¯¸ ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ì"""
        def __init__(self):
            print("ğŸ—„ï¸ ë”ë¯¸ ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ì ì´ˆê¸°í™”")
    
    DatabaseManager = DummyDatabaseManager

print(f"ğŸ“‹ ëª¨ë“ˆ ë¡œë“œ ìƒíƒœ: {sum(modules_loaded.values())}/{len(modules_loaded)}ê°œ ì„±ê³µ")

class ETFSystemLauncher:
    """ETF ì‹œìŠ¤í…œ í†µí•© ëŸ°ì²˜"""
    
    def __init__(self):
        self.update_manager = None
        self.scheduler = None
        self.portfolio_manager = None
        self.db_manager = None
        
    def initialize_system(self):
        """ì‹œìŠ¤í…œ ì´ˆê¸°í™”"""
        print("ğŸ—ï¸ ETF ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...")
        
        try:
            # ETF ìœ ë‹ˆë²„ìŠ¤ ì´ˆê¸°í™”
            print("ğŸ“Š ETF ìœ ë‹ˆë²„ìŠ¤ êµ¬ì¶• ì¤‘...")
            universe = ETFUniverse()
            print("âœ… ETF ìœ ë‹ˆë²„ìŠ¤ êµ¬ì¶• ì™„ë£Œ")
            
            # ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ì ì´ˆê¸°í™”
            print("ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ì ì´ˆê¸°í™” ì¤‘...")
            self.db_manager = DatabaseManager()
            print("âœ… ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ì ì´ˆê¸°í™” ì™„ë£Œ")
            
            # í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬ì ì´ˆê¸°í™”
            print("ğŸ’¼ í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬ì ì´ˆê¸°í™” ì¤‘...")
            try:
                # database_manager ì¸ìˆ˜ì™€ í•¨ê»˜ ì‹œë„
                self.portfolio_manager = PortfolioManager(database_manager=self.db_manager)
            except TypeError:
                # database_manager ì¸ìˆ˜ ì—†ì´ ì‹œë„
                self.portfolio_manager = PortfolioManager()
                # í•„ìš”í•˜ë©´ ë‚˜ì¤‘ì— database_manager ì„¤ì •
                if hasattr(self.portfolio_manager, 'set_database_manager'):
                    self.portfolio_manager.set_database_manager(self.db_manager)
                elif hasattr(self.portfolio_manager, 'db_manager'):
                    self.portfolio_manager.db_manager = self.db_manager
            print("âœ… í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬ì ì´ˆê¸°í™” ì™„ë£Œ")
            
            # ì—…ë°ì´íŠ¸ ê´€ë¦¬ì ì´ˆê¸°í™”
            print("ğŸ”„ ì—…ë°ì´íŠ¸ ê´€ë¦¬ì ì´ˆê¸°í™” ì¤‘...")
            self.update_manager = UpdateManager()
            print("âœ… ì—…ë°ì´íŠ¸ ê´€ë¦¬ì ì´ˆê¸°í™” ì™„ë£Œ")
            
            # ìŠ¤ì¼€ì¤„ëŸ¬ ì´ˆê¸°í™”
            print("ğŸ“… ìŠ¤ì¼€ì¤„ëŸ¬ ì´ˆê¸°í™” ì¤‘...")
            self.scheduler = Scheduler()
            print("âœ… ìŠ¤ì¼€ì¤„ëŸ¬ ì´ˆê¸°í™” ì™„ë£Œ")
            
            print("ğŸ‰ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ!")
            
            # ëª¨ë“ˆ ìƒíƒœ ìš”ì•½
            print(f"\nğŸ“‹ ì‚¬ìš© ì¤‘ì¸ ëª¨ë“ˆ:")
            for module, loaded in modules_loaded.items():
                status = "âœ… ì‹¤ì œ" if loaded else "âš ï¸ ë”ë¯¸"
                print(f"   - {module}: {status}")
            
            return True
            
        except Exception as e:
            print(f"âŒ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
            return False
    
    def run_full_update(self, max_etfs=None, delay=1.0):
        """ì „ì²´ ETF ì—…ë°ì´íŠ¸ ì‹¤í–‰"""
        print("\nğŸš€ ì „ì²´ ETF ì—…ë°ì´íŠ¸ ì‹œì‘")
        print("=" * 60)
        
        if not self.update_manager:
            print("âŒ ì—…ë°ì´íŠ¸ ê´€ë¦¬ìê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
            return False
        
        try:
            # ì‹œìŠ¤í…œ ìƒíƒœ ì²´í¬
            health = self.update_manager.get_system_status()
            print(f"ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ: {health.get('status', 'unknown')} ({health.get('health_score', 0):.1f}%)")
            
            # ì—…ë°ì´íŠ¸ ì‹¤í–‰
            summary = self.update_manager.batch_update_all_etfs(
                max_etfs=max_etfs,
                delay_between_updates=delay
            )
            
            if summary:
                print(f"\nğŸ¯ ì—…ë°ì´íŠ¸ ì™„ë£Œ ìš”ì•½:")
                print(f"- ëŒ€ìƒ ETF: {summary.total_etfs}ê°œ")
                print(f"- ì„±ê³µ: {summary.successful_updates}ê°œ")
                print(f"- ì‹¤íŒ¨: {summary.failed_updates}ê°œ")
                print(f"- ì„±ê³µë¥ : {summary.success_rate:.1f}%")
                print(f"- ì†Œìš”ì‹œê°„: {summary.total_duration/60:.1f}ë¶„")
                return True
            else:
                print("âŒ ì—…ë°ì´íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨")
                return False
                
        except Exception as e:
            print(f"âŒ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜: {e}")
            return False
    
    def run_scheduler(self):
        """ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰"""
        print("\nğŸ“… ETF ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘")
        print("=" * 60)
        
        if not self.scheduler:
            print("âŒ ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
            return False
        
        try:
            success = self.scheduler.start()
            
            if success:
                print("â° ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤")
                print("Ctrl+Cë¡œ ì¤‘ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤")
                
                # ë¬´í•œ ëŒ€ê¸° (ì‚¬ìš©ì ì¤‘ë‹¨ ì‹œê¹Œì§€)
                try:
                    while True:
                        time.sleep(60)
                        current_time = datetime.now().strftime("%H:%M:%S")
                        print(f"[{current_time}] ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì¤‘... (Ctrl+Cë¡œ ì¤‘ì§€)")
                
                except KeyboardInterrupt:
                    print("\nğŸ›‘ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ì§€ë¨")
                    self.scheduler.stop()
                    return True
            else:
                print("âŒ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘ ì‹¤íŒ¨")
                return False
                
        except Exception as e:
            print(f"âŒ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì‹¤íŒ¨: {e}")
            return False
    
    def run_dashboard(self, mode="auto"):
        """ëŒ€ì‹œë³´ë“œ ì‹¤í–‰"""
        print("\nğŸ“Š ETF ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ ì‹œì‘")
        print("=" * 60)
        
        try:
            if mode == "web":
                print("ğŸŒ ì›¹ ëŒ€ì‹œë³´ë“œ ì‹œì‘...")
                self._run_streamlit_dashboard()
            elif mode == "cli":
                print("ğŸ’» CLI ëŒ€ì‹œë³´ë“œ ì‹œì‘...")
                self._run_cli_dashboard()
            else:
                # ìë™ ì„ íƒ
                try:
                    import streamlit
                    print("ğŸŒ Streamlitì´ ì‚¬ìš© ê°€ëŠ¥í•˜ë¯€ë¡œ ì›¹ ëŒ€ì‹œë³´ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")
                    print("ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:8501 ìœ¼ë¡œ ì ‘ì†í•˜ì„¸ìš”")
                    self._run_streamlit_dashboard()
                except ImportError:
                    print("ğŸ’» Streamlitì´ ì—†ìœ¼ë¯€ë¡œ CLI ëŒ€ì‹œë³´ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")
                    self._run_cli_dashboard()
            
            return True
            
        except Exception as e:
            print(f"âŒ ëŒ€ì‹œë³´ë“œ ì‹¤í–‰ ì‹¤íŒ¨: {e}")
            return False

    def _run_streamlit_dashboard(self):
        """Streamlit ëŒ€ì‹œë³´ë“œ ì‹¤í–‰"""
        import subprocess
        import sys
        
        # Streamlit ì•± ì‹¤í–‰
        dashboard_path = "web/dashboard.py"
        
        # íŒŒì¼ì´ ì—†ìœ¼ë©´ ê°„ë‹¨í•œ ë”ë¯¸ ëŒ€ì‹œë³´ë“œ ìƒì„±
        if not os.path.exists(dashboard_path):
            os.makedirs("web", exist_ok=True)
            dummy_dashboard = '''
import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import datetime

st.title("ğŸ¯ ETF í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ")
st.sidebar.title("ğŸ“‹ ë©”ë‰´")

# ë”ë¯¸ ë°ì´í„°
data = {
    "ETF": ["KODEX 200", "TIGER ë¯¸êµ­S&P500", "KODEX êµ­ê³ ì±„10ë…„"],
    "ìˆ˜ìµë¥ ": [5.2, 8.1, 2.3],
    "ë³´ìœ ë¹„ì¤‘": [40, 35, 25]
}
df = pd.DataFrame(data)

# ë©”ì¸ ëŒ€ì‹œë³´ë“œ
col1, col2, col3 = st.columns(3)
with col1:
    st.metric("ì´ ìì‚°", "â‚©50,000,000", "5.2%")
with col2:
    st.metric("ì´ ìˆ˜ìµë¥ ", "8.5%", "1.2%")
with col3:
    st.metric("ETF ê°œìˆ˜", "3ê°œ", "0")

# ì°¨íŠ¸
fig = px.pie(df, values="ë³´ìœ ë¹„ì¤‘", names="ETF", title="ìì‚° ë°°ë¶„")
st.plotly_chart(fig)

# ìˆ˜ìµë¥  ì°¨íŠ¸
fig2 = px.bar(df, x="ETF", y="ìˆ˜ìµë¥ ", title="ETFë³„ ìˆ˜ìµë¥ ")
st.plotly_chart(fig2)

st.info("ğŸ’¡ ì´ê²ƒì€ ë”ë¯¸ ëŒ€ì‹œë³´ë“œì…ë‹ˆë‹¤. ì‹¤ì œ ë°ì´í„°ëŠ” ì‹œìŠ¤í…œ êµ¬ì¶• í›„ í‘œì‹œë©ë‹ˆë‹¤.")
'''
            with open(dashboard_path, 'w', encoding='utf-8') as f:
                f.write(dummy_dashboard)
            print(f"ğŸ“ ë”ë¯¸ ëŒ€ì‹œë³´ë“œ ìƒì„±: {dashboard_path}")
        
        cmd = [sys.executable, "-m", "streamlit", "run", dashboard_path]
        
        try:
            subprocess.run(cmd)
        except KeyboardInterrupt:
            print("\nğŸ›‘ ëŒ€ì‹œë³´ë“œ ì¤‘ì§€ë¨")
        except Exception as e:
            print(f"âŒ ëŒ€ì‹œë³´ë“œ ì‹¤í–‰ ì‹¤íŒ¨: {e}")
    
    def _run_cli_dashboard(self):
        """CLI ëŒ€ì‹œë³´ë“œ ì‹¤í–‰"""
        print("ğŸ’» CLI ëŒ€ì‹œë³´ë“œ ëª¨ë“œ")
        print("=" * 40)
        
        while True:
            try:
                print("\nğŸ“Š ëŒ€ì‹œë³´ë“œ ë©”ë‰´:")
                print("1. í¬íŠ¸í´ë¦¬ì˜¤ í˜„í™©")
                print("2. ETF ê°€ê²© ì¡°íšŒ") 
                print("3. ì‹œìŠ¤í…œ ìƒíƒœ")
                print("4. ëŒì•„ê°€ê¸°")
                
                choice = input("\nì„ íƒ (1-4): ").strip()
                
                if choice == "1":
                    print("\nğŸ’¼ í¬íŠ¸í´ë¦¬ì˜¤ í˜„í™©")
                    print("ğŸ“Š ë”ë¯¸ ë°ì´í„°:")
                    print("- ì´ ìì‚°: â‚©50,000,000")
                    print("- ì´ ìˆ˜ìµë¥ : 8.5%")
                    print("- KODEX 200: 40% (â‚©20,000,000)")
                    print("- TIGER ë¯¸êµ­S&P500: 35% (â‚©17,500,000)")
                    print("- KODEX êµ­ê³ ì±„10ë…„: 25% (â‚©12,500,000)")
                
                elif choice == "2":
                    etf_code = input("ETF ì½”ë“œ ì…ë ¥ (ì˜ˆ: 069500): ").strip()
                    if etf_code:
                        print(f"\nğŸ“ˆ {etf_code} ì •ë³´ (ë”ë¯¸ ë°ì´í„°)")
                        print("- í˜„ì¬ê°€: â‚©10,500")
                        print("- ì „ì¼ ëŒ€ë¹„: +1.2% (+125ì›)")
                        print("- ê±°ë˜ëŸ‰: 1,234,567ì£¼")
                        print("- 52ì£¼ ìµœê³ ê°€: â‚©11,200")
                        print("- 52ì£¼ ìµœì €ê°€: â‚©9,800")
                    
                elif choice == "3":
                    self.system_status()
                
                elif choice == "4":
                    break
                    
                else:
                    print("âŒ 1-4 ì¤‘ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”")
                    
            except KeyboardInterrupt:
                print("\nğŸ›‘ CLI ëŒ€ì‹œë³´ë“œ ì¢…ë£Œ")
                break

    def system_status(self):
        """ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸"""
        print("\nğŸ” ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸")
        print("=" * 60)
        
        if not self.update_manager:
            print("âŒ ì—…ë°ì´íŠ¸ ê´€ë¦¬ìê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
            return False
        
        try:
            # ì‹œìŠ¤í…œ ê±´ê°• ìƒíƒœ
            health = self.update_manager.get_system_status()
            
            print("ğŸ“Š ì‹œìŠ¤í…œ ê±´ê°• ìƒíƒœ:")
            print(f"- ì´ ETF: {health.get('total_etfs', 0)}ê°œ")
            print(f"- ì—…ë°ì´íŠ¸ëœ ETF: {health.get('updated_etfs', 0)}ê°œ")
            print(f"- ê°€ê²© ì •ë³´ ë³´ìœ : {health.get('price_available', 0)}ê°œ")
            print(f"- 24ì‹œê°„ ë‚´ ì—…ë°ì´íŠ¸: {health.get('recent_updates_24h', 0)}ê°œ")
            print(f"- ê±´ê°• ì ìˆ˜: {health.get('health_score', 0):.1f}%")
            print(f"- ìƒíƒœ: {health.get('status', 'unknown')}")
            
            # ì—…ë°ì´íŠ¸ ìƒíƒœ
            status = self.update_manager.get_current_status()
            print(f"\nğŸ”„ ì—…ë°ì´íŠ¸ ìƒíƒœ:")
            print(f"- ì§„í–‰ ì¤‘: {'ì˜ˆ' if status.get('is_updating') else 'ì•„ë‹ˆì˜¤'}")
            print(f"- ì§„í–‰ë¥ : {status.get('progress', 0):.1f}%")
            print(f"- ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {status.get('last_update', 'ì•Œ ìˆ˜ ì—†ìŒ')}")
            
            # ìµœê·¼ íˆìŠ¤í† ë¦¬
            history = self.update_manager.get_update_history(3)
            if history:
                print(f"\nğŸ“‹ ìµœê·¼ ì—…ë°ì´íŠ¸ íˆìŠ¤í† ë¦¬:")
                for i, record in enumerate(history):
                    print(f"{i+1}. {record['start_time'][:19]} - "
                          f"ì„±ê³µë¥  {record['success_rate']:.1f}% "
                          f"({record['successful_updates']}/{record['total_etfs']})")
            
            # ëª¨ë“ˆ ìƒíƒœ
            print(f"\nğŸ”§ ëª¨ë“ˆ ìƒíƒœ:")
            for module, loaded in modules_loaded.items():
                status_text = "âœ… ì •ìƒ" if loaded else "âš ï¸ ë”ë¯¸"
                print(f"- {module}: {status_text}")
            
            return True
            
        except Exception as e:
            print(f"âŒ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: {e}")
            return False
    
    def interactive_menu(self):
        """ëŒ€í™”í˜• ë©”ë‰´"""
        print("\nğŸ¯ ETF ì‹œìŠ¤í…œ ëŒ€í™”í˜• ë©”ë‰´")
        print("=" * 60)
        
        while True:
            try:
                print("\nğŸ“‹ ë©”ë‰´ ì„ íƒ:")
                print("1. ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸")
                print("2. ë¹ ë¥¸ ì—…ë°ì´íŠ¸ (10ê°œ ETF)")
                print("3. ì „ì²´ ì—…ë°ì´íŠ¸")
                print("4. ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘")
                print("5. ëŒ€ì‹œë³´ë“œ ì‹¤í–‰")
                print("6. ì¢…ë£Œ")
                
                choice = input("\nì„ íƒ (1-6): ").strip()
                
                if choice == "1":
                    self.system_status()
                
                elif choice == "2":
                    print("\nâš¡ ë¹ ë¥¸ ì—…ë°ì´íŠ¸ ì‹¤í–‰...")
                    self.run_full_update(max_etfs=10, delay=0.5)
                
                elif choice == "3":
                    confirm = input("\nì „ì²´ ì—…ë°ì´íŠ¸ëŠ” ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): ")
                    if confirm.lower() == 'y':
                        self.run_full_update()
                    else:
                        print("ì „ì²´ ì—…ë°ì´íŠ¸ ì·¨ì†Œë¨")
                
                elif choice == "4":
                    self.run_scheduler()
                
                elif choice == "5":
                    dashboard_mode = input("ëŒ€ì‹œë³´ë“œ ëª¨ë“œ ì„ íƒ (web/cli/auto): ").strip().lower()
                    if dashboard_mode in ['web', 'cli', 'auto']:
                        self.run_dashboard(dashboard_mode)
                    else:
                        self.run_dashboard('auto')
                
                elif choice == "6":
                    print("ğŸ‘‹ ì‹œìŠ¤í…œì„ ì¢…ë£Œí•©ë‹ˆë‹¤")
                    break
                
                else:
                    print("âŒ 1-6 ì¤‘ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”")
            
            except KeyboardInterrupt:
                print("\n\nğŸ‘‹ ì‚¬ìš©ìì— ì˜í•´ ì¢…ë£Œë¨")
                break
            except Exception as e:
                print(f"\nâŒ ì˜¤ë¥˜ ë°œìƒ: {e}")


def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    parser = argparse.ArgumentParser(description="ETF ì¥ê¸°íˆ¬ì ê´€ë¦¬ ì‹œìŠ¤í…œ")
    parser.add_argument("--mode", choices=["update", "scheduler", "dashboard", "status", "interactive"], 
                       default="interactive", help="ì‹¤í–‰ ëª¨ë“œ ì„ íƒ")
    parser.add_argument("--max-etfs", type=int, help="ì—…ë°ì´íŠ¸í•  ìµœëŒ€ ETF ê°œìˆ˜")
    parser.add_argument("--delay", type=float, default=1.0, help="ì—…ë°ì´íŠ¸ ê°„ ì§€ì—°ì‹œê°„(ì´ˆ)")
    parser.add_argument("--dashboard-mode", choices=["web", "cli", "auto"], default="auto", 
                       help="ëŒ€ì‹œë³´ë“œ ëª¨ë“œ")
    
    args = parser.parse_args()
    
    print("ğŸš€ ETF ì¥ê¸°íˆ¬ì ê´€ë¦¬ ì‹œìŠ¤í…œ")
    print("=" * 60)
    print(f"â° ì‹œì‘ ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"ğŸ¯ ì‹¤í–‰ ëª¨ë“œ: {args.mode}")
    
    # ì‹œìŠ¤í…œ ëŸ°ì²˜ ì´ˆê¸°í™”
    launcher = ETFSystemLauncher()
    
    # ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    if not launcher.initialize_system():
        print("âŒ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨")
        sys.exit(1)
    
    # ëª¨ë“œë³„ ì‹¤í–‰
    try:
        if args.mode == "update":
            success = launcher.run_full_update(args.max_etfs, args.delay)
            sys.exit(0 if success else 1)
        
        elif args.mode == "scheduler":
            success = launcher.run_scheduler()
            sys.exit(0 if success else 1)
        
        elif args.mode == "dashboard":
            success = launcher.run_dashboard(args.dashboard_mode)
            sys.exit(0 if success else 1)
        
        elif args.mode == "status":
            success = launcher.system_status()
            sys.exit(0 if success else 1)
        
        elif args.mode == "interactive":
            launcher.interactive_menu()
        
        else:
            print(f"âŒ ì•Œ ìˆ˜ ì—†ëŠ” ëª¨ë“œ: {args.mode}")
            sys.exit(1)
    
    except KeyboardInterrupt:
        print("\n\nğŸ‘‹ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë¨")
        sys.exit(0)
    except Exception as e:
        print(f"\nâŒ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()


# ==========================================
# ì‚¬ìš© ì˜ˆì œ
# ==========================================

"""
ì‚¬ìš© ë°©ë²•:

1. ëŒ€í™”í˜• ë©”ë‰´ (ê¸°ë³¸):
   python main.py

2. ì „ì²´ ETF ì—…ë°ì´íŠ¸:
   python main.py --mode update

3. 10ê°œ ETFë§Œ ë¹ ë¥¸ ì—…ë°ì´íŠ¸:
   python main.py --mode update --max-etfs 10 --delay 0.5

4. ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘:
   python main.py --mode scheduler

5. ì›¹ ëŒ€ì‹œë³´ë“œ ì‹œì‘:
   python main.py --mode dashboard --dashboard-mode web

6. CLI ëŒ€ì‹œë³´ë“œ ì‹œì‘:
   python main.py --mode dashboard --dashboard-mode cli

7. ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸:
   python main.py --mode status

í•„ìˆ˜ íŒ¨í‚¤ì§€:
- pip install schedule (ê¸°ë³¸ ìŠ¤ì¼€ì¤„ëŸ¬)

ì„ íƒì  íŒ¨í‚¤ì§€ (ì—†ì–´ë„ ì‘ë™):
- pip install apscheduler (ê³ ê¸‰ ìŠ¤ì¼€ì¤„ëŸ¬)
- pip install streamlit plotly (ì›¹ ëŒ€ì‹œë³´ë“œ)
- pip install pykrx (ì‹¤ì œ ì‹œì¥ ë°ì´í„°)

âš ï¸ ëª¨ë“ˆì´ ì—†ìœ¼ë©´ ë”ë¯¸ ë²„ì „ìœ¼ë¡œ ìë™ ëŒ€ì²´ë©ë‹ˆë‹¤.
"""