"""
ETF ìœ ë‹ˆë²„ìŠ¤ ê´€ë¦¬ ëª¨ë“ˆ
í•œêµ­ì—ì„œ ê±°ë˜ ê°€ëŠ¥í•œ ëª¨ë“  ETF ì •ë³´ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬
"""

import pandas as pd
import logging
from typing import Dict, List, Optional, Tuple
from datetime import datetime
from pathlib import Path
import json

logger = logging.getLogger(__name__)

class ETFUniverse:
    """ETF ìœ ë‹ˆë²„ìŠ¤ ê´€ë¦¬ í´ë˜ìŠ¤"""

    def __init__(self, db_path=None, **kwargs):
        """
        ETF ìœ ë‹ˆë²„ìŠ¤ ì´ˆê¸°í™”
        
        Args:
            db_path: ë°ì´í„°ë² ì´ìŠ¤ ê²½ë¡œ (ì„ íƒì , í˜¸í™˜ì„±ì„ ìœ„í•´ ì¶”ê°€)
            **kwargs: ê¸°íƒ€ ë§¤ê°œë³€ìˆ˜
        """
        self.db_path = db_path
        self.etf_data = {}
        self.categories = {}
        self._initialize_etf_universe()
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ì§€ì›
        if db_path:
            self._load_from_database()
        
        logger.info(f"ETF ìœ ë‹ˆë²„ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ (DB: {db_path if db_path else 'N/A'})")

    
    def _initialize_etf_universe(self):
        """í•œêµ­ ETF ìœ ë‹ˆë²„ìŠ¤ ì´ˆê¸°í™”"""
        self.categories = {
            'domestic_equity': {
                'name': 'êµ­ë‚´ ì£¼ì‹',
                'subcategories': {
                    'large_cap': 'ëŒ€í˜•ì£¼',
                    'mid_small_cap': 'ì¤‘ì†Œí˜•ì£¼', 
                    'dividend': 'ë°°ë‹¹ì£¼',
                    'value': 'ê°€ì¹˜ì£¼',
                    'growth': 'ì„±ì¥ì£¼',
                    'sector': 'ì„¹í„°ë³„'
                }
            },
            'foreign_equity': {
                'name': 'í•´ì™¸ ì£¼ì‹',
                'subcategories': {
                    'us': 'ë¯¸êµ­',
                    'developed': 'ì„ ì§„êµ­',
                    'emerging': 'ì‹ í¥êµ­',
                    'china': 'ì¤‘êµ­',
                    'japan': 'ì¼ë³¸',
                    'europe': 'ìœ ëŸ½'
                }
            },
            'bonds': {
                'name': 'ì±„ê¶Œ',
                'subcategories': {
                    'government': 'êµ­ì±„',
                    'corporate': 'íšŒì‚¬ì±„',
                    'foreign_government': 'í•´ì™¸êµ­ì±„',
                    'foreign_corporate': 'í•´ì™¸íšŒì‚¬ì±„',
                    'high_yield': 'í•˜ì´ì¼ë“œ'
                }
            },
            'alternatives': {
                'name': 'ëŒ€ì•ˆíˆ¬ì',
                'subcategories': {
                    'reits': 'ë¦¬ì¸ ',
                    'commodities': 'ì›ìì¬',
                    'gold': 'ê¸ˆ',
                    'infrastructure': 'ì¸í”„ë¼'
                }
            },
            'thematic': {
                'name': 'í…Œë§ˆ/ì„¹í„°',
                'subcategories': {
                    'technology': 'ê¸°ìˆ ',
                    'healthcare': 'í—¬ìŠ¤ì¼€ì–´',
                    'esg': 'ESG',
                    'battery': 'ë°°í„°ë¦¬',
                    'semiconductor': 'ë°˜ë„ì²´'
                }
            }
        }
        
        # ì£¼ìš” ETF ë°ì´í„° ì´ˆê¸°í™”
        self._load_major_etfs()
    
    def _load_major_etfs(self):
        """ì£¼ìš” ETF ë°ì´í„° ë¡œë“œ"""
        major_etfs = {
            # êµ­ë‚´ ì£¼ì‹ ETF
            '069500': {
                'name': 'KODEX 200',
                'category': 'domestic_equity',
                'subcategory': 'large_cap',
                'asset_class': 'equity',
                'region': 'KR',
                'currency': 'KRW',
                'expense_ratio': 0.15,
                'tracking_index': 'KOSPI 200',
                'fund_company': 'ì‚¼ì„±ìì‚°ìš´ìš©',
                'description': 'ì½”ìŠ¤í”¼ 200 ì§€ìˆ˜ë¥¼ ì¶”ì¢…í•˜ëŠ” ëŒ€í‘œì ì¸ êµ­ë‚´ ëŒ€í˜•ì£¼ ETF',
                'market_price': 28400,
                'aum': 20000  # ì–µì› ë‹¨ìœ„
            },
            '114800': {
                'name': 'KODEX ì¸ë²„ìŠ¤',
                'category': 'domestic_equity',
                'subcategory': 'inverse',
                'asset_class': 'equity',
                'region': 'KR',
                'currency': 'KRW',
                'expense_ratio': 0.35,
                'tracking_index': 'KOSPI 200 ì¸ë²„ìŠ¤',
                'fund_company': 'ì‚¼ì„±ìì‚°ìš´ìš©',
                'description': 'ì½”ìŠ¤í”¼ 200 ì§€ìˆ˜ì˜ ì¼ì¼ ì—­ë°©í–¥ ìˆ˜ìµë¥ ì„ ì¶”ì¢…',
                'market_price': 5800,
                'aum': 3000
            },
            '229200': {
                'name': 'KODEX ì½”ìŠ¤ë‹¥150',
                'category': 'domestic_equity',
                'subcategory': 'growth',
                'asset_class': 'equity',
                'region': 'KR',
                'currency': 'KRW',
                'expense_ratio': 0.15,
                'tracking_index': 'KOSDAQ 150',
                'fund_company': 'ì‚¼ì„±ìì‚°ìš´ìš©',
                'description': 'ì½”ìŠ¤ë‹¥ 150 ì§€ìˆ˜ë¥¼ ì¶”ì¢…í•˜ëŠ” ì„±ì¥ì£¼ ì¤‘ì‹¬ ETF',
                'market_price': 9800,
                'aum': 8000
            },
            '360750': {
                'name': 'TIGER ë¯¸êµ­S&P500',
                'category': 'foreign_equity',
                'subcategory': 'us',
                'asset_class': 'equity',
                'region': 'US',
                'currency': 'USD',
                'expense_ratio': 0.045,
                'tracking_index': 'S&P 500',
                'fund_company': 'ë¯¸ë˜ì—ì…‹ìì‚°ìš´ìš©',
                'description': 'ë¯¸êµ­ S&P 500 ì§€ìˆ˜ë¥¼ ì¶”ì¢…í•˜ëŠ” ëŒ€í‘œì ì¸ ë¯¸êµ­ì£¼ì‹ ETF',
                'market_price': 15800,
                'aum': 25000
            },
            '133690': {
                'name': 'KODEX ë‚˜ìŠ¤ë‹¥100',
                'category': 'foreign_equity',
                'subcategory': 'us',
                'asset_class': 'equity',
                'region': 'US',
                'currency': 'USD',
                'expense_ratio': 0.045,
                'tracking_index': 'NASDAQ 100',
                'fund_company': 'ì‚¼ì„±ìì‚°ìš´ìš©',
                'description': 'ë‚˜ìŠ¤ë‹¥ 100 ì§€ìˆ˜ë¥¼ ì¶”ì¢…í•˜ëŠ” ë¯¸êµ­ ê¸°ìˆ ì£¼ ì¤‘ì‹¬ ETF',
                'market_price': 24500,
                'aum': 15000
            },
            '195930': {
                'name': 'KODEX ì„ ì§„êµ­MSCI',
                'category': 'foreign_equity',
                'subcategory': 'developed',
                'asset_class': 'equity',
                'region': 'Global',
                'currency': 'USD',
                'expense_ratio': 0.08,
                'tracking_index': 'MSCI World',
                'fund_company': 'ì‚¼ì„±ìì‚°ìš´ìš©',
                'description': 'ì „ ì„¸ê³„ ì„ ì§„êµ­ ì£¼ì‹ì— ë¶„ì‚°íˆ¬ìí•˜ëŠ” ê¸€ë¡œë²Œ ETF',
                'market_price': 13200,
                'aum': 5000
            },
            '195980': {
                'name': 'TIGER ì‹ í¥êµ­MSCI',
                'category': 'foreign_equity',
                'subcategory': 'emerging',
                'asset_class': 'equity',
                'region': 'Emerging',
                'currency': 'USD',
                'expense_ratio': 0.49,
                'tracking_index': 'MSCI Emerging Markets',
                'fund_company': 'ë¯¸ë˜ì—ì…‹ìì‚°ìš´ìš©',
                'description': 'ì‹ í¥êµ­ ì£¼ì‹ì— ë¶„ì‚°íˆ¬ìí•˜ëŠ” ETF',
                'market_price': 8400,
                'aum': 3000
            },
            '160570': {
                'name': 'TIGER ì¤‘êµ­CSI300',
                'category': 'foreign_equity',
                'subcategory': 'china',
                'asset_class': 'equity',
                'region': 'CN',
                'currency': 'CNY',
                'expense_ratio': 0.19,
                'tracking_index': 'CSI 300',
                'fund_company': 'ë¯¸ë˜ì—ì…‹ìì‚°ìš´ìš©',
                'description': 'ì¤‘êµ­ Aì£¼ ì‹œì¥ì˜ ëŒ€í˜•ì£¼ì— íˆ¬ìí•˜ëŠ” ETF',
                'market_price': 6200,
                'aum': 2000
            },
            # ì±„ê¶Œ ETF
            '114260': {
                'name': 'KODEX êµ­ê³ ì±„10ë…„',
                'category': 'bonds',
                'subcategory': 'government',
                'asset_class': 'fixed_income',
                'region': 'KR',
                'currency': 'KRW',
                'expense_ratio': 0.15,
                'tracking_index': 'KTB 10ë…„ êµ­ê³ ì±„',
                'fund_company': 'ì‚¼ì„±ìì‚°ìš´ìš©',
                'description': '10ë…„ ë§Œê¸° êµ­ê³ ì±„ì— íˆ¬ìí•˜ëŠ” ì±„ê¶Œ ETF',
                'market_price': 108500,
                'aum': 12000
            },
            '305080': {
                'name': 'TIGER ë¯¸êµ­ì±„10ë…„',
                'category': 'bonds',
                'subcategory': 'foreign_government',
                'asset_class': 'fixed_income',
                'region': 'US',
                'currency': 'USD',
                'expense_ratio': 0.14,
                'tracking_index': 'US Treasury 10Y',
                'fund_company': 'ë¯¸ë˜ì—ì…‹ìì‚°ìš´ìš©',
                'description': 'ë¯¸êµ­ 10ë…„ êµ­ì±„ì— íˆ¬ìí•˜ëŠ” í•´ì™¸ì±„ê¶Œ ETF',
                'market_price': 8900,
                'aum': 4000
            },
            '130730': {
                'name': 'KODEX ê¸€ë¡œë²Œí•˜ì´ì¼ë“œ',
                'category': 'bonds',
                'subcategory': 'high_yield',
                'asset_class': 'fixed_income',
                'region': 'Global',
                'currency': 'USD',
                'expense_ratio': 0.45,
                'tracking_index': 'ICE BofA Global High Yield',
                'fund_company': 'ì‚¼ì„±ìì‚°ìš´ìš©',
                'description': 'ê¸€ë¡œë²Œ í•˜ì´ì¼ë“œ ì±„ê¶Œì— íˆ¬ìí•˜ëŠ” ETF',
                'market_price': 9500,
                'aum': 1500
            },
            # ë¦¬ì¸  ETF
            '329200': {
                'name': 'KODEX ë¦¬ì¸ ',
                'category': 'alternatives',
                'subcategory': 'reits',
                'asset_class': 'reits',
                'region': 'KR',
                'currency': 'KRW',
                'expense_ratio': 0.5,
                'tracking_index': 'KRX REITs',
                'fund_company': 'ì‚¼ì„±ìì‚°ìš´ìš©',
                'description': 'êµ­ë‚´ ë¦¬ì¸ ì— íˆ¬ìí•˜ëŠ” ë¶€ë™ì‚° ETF',
                'market_price': 7200,
                'aum': 800
            },
            '351590': {
                'name': 'TIGER ë¯¸êµ­ë¦¬ì¸ ',
                'category': 'alternatives',
                'subcategory': 'reits',
                'asset_class': 'reits',
                'region': 'US',
                'currency': 'USD',
                'expense_ratio': 0.49,
                'tracking_index': 'FTSE NAREIT Equity REITs',
                'fund_company': 'ë¯¸ë˜ì—ì…‹ìì‚°ìš´ìš©',
                'description': 'ë¯¸êµ­ ë¦¬ì¸ ì— íˆ¬ìí•˜ëŠ” í•´ì™¸ ë¶€ë™ì‚° ETF',
                'market_price': 11200,
                'aum': 2500
            },
            # ê¸ˆ ETF
            '132030': {
                'name': 'KODEX ê³¨ë“œì„ ë¬¼',
                'category': 'alternatives',
                'subcategory': 'gold',
                'asset_class': 'commodities',
                'region': 'Global',
                'currency': 'USD',
                'expense_ratio': 0.49,
                'tracking_index': 'Gold Futures',
                'fund_company': 'ì‚¼ì„±ìì‚°ìš´ìš©',
                'description': 'ê¸ˆ ì„ ë¬¼ì— íˆ¬ìí•˜ëŠ” ì›ìì¬ ETF',
                'market_price': 9800,
                'aum': 3500
            },
            # í…Œë§ˆ ETF
            '305540': {
                'name': 'KODEX 2ì°¨ì „ì§€ì‚°ì—…',
                'category': 'thematic',
                'subcategory': 'battery',
                'asset_class': 'equity',
                'region': 'Global',
                'currency': 'KRW',
                'expense_ratio': 0.45,
                'tracking_index': 'Solactive 2ì°¨ì „ì§€ ë° ë°°í„°ë¦¬ Value-Chain',
                'fund_company': 'ì‚¼ì„±ìì‚°ìš´ìš©',
                'description': 'ì „ ì„¸ê³„ 2ì°¨ì „ì§€ ê´€ë ¨ ê¸°ì—…ì— íˆ¬ìí•˜ëŠ” í…Œë§ˆ ETF',
                'market_price': 18500,
                'aum': 5000
            },
            '091160': {
                'name': 'KODEX ë°˜ë„ì²´',
                'category': 'thematic',
                'subcategory': 'semiconductor',
                'asset_class': 'equity',
                'region': 'KR',
                'currency': 'KRW',
                'expense_ratio': 0.49,
                'tracking_index': 'KRX ë°˜ë„ì²´',
                'fund_company': 'ì‚¼ì„±ìì‚°ìš´ìš©',
                'description': 'êµ­ë‚´ ë°˜ë„ì²´ ê¸°ì—…ì— íˆ¬ìí•˜ëŠ” ì„¹í„° ETF',
                'market_price': 12800,
                'aum': 4000
            },
            '148020': {
                'name': 'KODEX ESG Korea',
                'category': 'thematic',
                'subcategory': 'esg',
                'asset_class': 'equity',
                'region': 'KR',
                'currency': 'KRW',
                'expense_ratio': 0.25,
                'tracking_index': 'KRX ESG Leader 150',
                'fund_company': 'ì‚¼ì„±ìì‚°ìš´ìš©',
                'description': 'ESG ìš°ìˆ˜ ê¸°ì—…ì— íˆ¬ìí•˜ëŠ” ì§€ì†ê°€ëŠ¥ íˆ¬ì ETF',
                'market_price': 14200,
                'aum': 2000
            }
        }
        
        self.etf_data = major_etfs
        logger.info(f"ì£¼ìš” ETF {len(major_etfs)}ê°œ ë¡œë“œ ì™„ë£Œ")
    
    def get_etf_info(self, etf_code: str) -> Optional[Dict]:
        """íŠ¹ì • ETF ì •ë³´ ì¡°íšŒ"""
        return self.etf_data.get(etf_code)
    
    def get_etfs_by_category(self, category: str, 
                           subcategory: Optional[str] = None) -> List[Dict]:
        """ì¹´í…Œê³ ë¦¬ë³„ ETF ëª©ë¡ ì¡°íšŒ"""
        etfs = []
        
        for code, etf_info in self.etf_data.items():
            if etf_info['category'] == category:
                if subcategory is None or etf_info.get('subcategory') == subcategory:
                    etf_info_copy = etf_info.copy()
                    etf_info_copy['code'] = code
                    etfs.append(etf_info_copy)
        
        return etfs
    
    def get_etfs_by_asset_class(self, asset_class: str) -> List[Dict]:
        """ìì‚°êµ°ë³„ ETF ëª©ë¡ ì¡°íšŒ"""
        etfs = []
        
        for code, etf_info in self.etf_data.items():
            if etf_info['asset_class'] == asset_class:
                etf_info_copy = etf_info.copy()
                etf_info_copy['code'] = code
                etfs.append(etf_info_copy)
        
        return etfs
    
    def get_etfs_by_region(self, region: str) -> List[Dict]:
        """ì§€ì—­ë³„ ETF ëª©ë¡ ì¡°íšŒ"""
        etfs = []
        
        for code, etf_info in self.etf_data.items():
            if etf_info['region'] == region:
                etf_info_copy = etf_info.copy()
                etf_info_copy['code'] = code
                etfs.append(etf_info_copy)
        
        return etfs
    
    def search_etfs(self, **filters) -> List[Dict]:
        """ë‹¤ì¤‘ ì¡°ê±´ ETF ê²€ìƒ‰"""
        etfs = []
        
        for code, etf_info in self.etf_data.items():
            match = True
            
            for key, value in filters.items():
                if key in etf_info:
                    if isinstance(value, list):
                        if etf_info[key] not in value:
                            match = False
                            break
                    else:
                        if etf_info[key] != value:
                            match = False
                            break
                else:
                    match = False
                    break
            
            if match:
                etf_info_copy = etf_info.copy()
                etf_info_copy['code'] = code
                etfs.append(etf_info_copy)
        
        return etfs
    
    def get_low_cost_etfs(self, expense_ratio_threshold: float = 0.3) -> List[Dict]:
        """ì €ë¹„ìš© ETF ëª©ë¡ ì¡°íšŒ"""
        etfs = []
        
        for code, etf_info in self.etf_data.items():
            if etf_info.get('expense_ratio', 999) <= expense_ratio_threshold:
                etf_info_copy = etf_info.copy()
                etf_info_copy['code'] = code
                etfs.append(etf_info_copy)
        
        # ë¹„ìš© ìˆœìœ¼ë¡œ ì •ë ¬
        etfs.sort(key=lambda x: x.get('expense_ratio', 999))
        return etfs
    
    def get_core_satellite_recommendations(self) -> Dict[str, List[Dict]]:
        """ì½”ì–´-ìƒˆí‹€ë¼ì´íŠ¸ ì „ëµ ì¶”ì²œ ETF"""
        recommendations = {
            'core': [
                # ì½”ì–´ (70-80%): ì‹œì¥ ì „ì²´ë¥¼ ëŒ€í‘œí•˜ëŠ” ê´‘ë²”ìœ„í•œ ETF
                self.etf_data.get('069500'),  # KODEX 200
                self.etf_data.get('360750'),  # TIGER ë¯¸êµ­S&P500
                self.etf_data.get('195930'),  # KODEX ì„ ì§„êµ­MSCI
                self.etf_data.get('114260')   # KODEX êµ­ê³ ì±„10ë…„
            ],
            'satellite': [
                # ìƒˆí‹€ë¼ì´íŠ¸ (20-30%): ì„±ì¥ì„±ì´ë‚˜ í…Œë§ˆê°€ ìˆëŠ” ETF
                self.etf_data.get('229200'),  # KODEX ì½”ìŠ¤ë‹¥150
                self.etf_data.get('133690'),  # KODEX ë‚˜ìŠ¤ë‹¥100
                self.etf_data.get('195980'),  # TIGER ì‹ í¥êµ­MSCI
                self.etf_data.get('305540'),  # KODEX 2ì°¨ì „ì§€ì‚°ì—…
                self.etf_data.get('329200')   # KODEX ë¦¬ì¸ 
            ]
        }
        
        # None ê°’ ì œê±°
        recommendations['core'] = [etf for etf in recommendations['core'] if etf]
        recommendations['satellite'] = [etf for etf in recommendations['satellite'] if etf]
        
        return recommendations
    
    def get_lifecycle_recommendations(self, age: int) -> List[Dict]:
        """ìƒì• ì£¼ê¸°ë³„ ì¶”ì²œ ETF"""
        if age < 30:
            # 20ëŒ€: ê³µê²©ì  ì„±ì¥ (ì£¼ì‹ 90%, ì±„ê¶Œ 10%)
            recommended_codes = ['360750', '069500', '229200', '133690', '195980']
        elif age < 40:
            # 30ëŒ€: ê· í˜• ì„±ì¥ (ì£¼ì‹ 80%, ì±„ê¶Œ 20%)
            recommended_codes = ['069500', '360750', '195930', '114260', '229200']
        elif age < 50:
            # 40ëŒ€: ì•ˆì • ì„±ì¥ (ì£¼ì‹ 70%, ì±„ê¶Œ 30%)
            recommended_codes = ['069500', '360750', '114260', '305080', '329200']
        else:
            # 50ëŒ€+: ìë³¸ ë³´ì „ (ì£¼ì‹ 60%, ì±„ê¶Œ 40%)
            recommended_codes = ['069500', '114260', '305080', '360750', '130730']
        
        recommendations = []
        for code in recommended_codes:
            etf_info = self.etf_data.get(code)
            if etf_info:
                etf_info_copy = etf_info.copy()
                etf_info_copy['code'] = code
                recommendations.append(etf_info_copy)
        
        return recommendations
    
    def get_global_diversified_portfolio(self) -> List[Dict]:
        """ê¸€ë¡œë²Œ ë¶„ì‚° í¬íŠ¸í´ë¦¬ì˜¤ ì¶”ì²œ"""
        recommended_codes = [
            '069500',  # êµ­ë‚´ ì£¼ì‹ 25%
            '360750',  # ë¯¸êµ­ ì£¼ì‹ 30%
            '195930',  # ì„ ì§„êµ­ ì£¼ì‹ 20%
            '195980',  # ì‹ í¥êµ­ ì£¼ì‹ 10%
            '114260',  # êµ­ë‚´ ì±„ê¶Œ 10%
            '305080'   # í•´ì™¸ ì±„ê¶Œ 5%
        ]
        
        recommendations = []
        for code in recommended_codes:
            etf_info = self.etf_data.get(code)
            if etf_info:
                etf_info_copy = etf_info.copy()
                etf_info_copy['code'] = code
                recommendations.append(etf_info_copy)
        
        return recommendations
    
    def get_category_summary(self) -> Dict[str, int]:
        """ì¹´í…Œê³ ë¦¬ë³„ ETF ê°œìˆ˜ ìš”ì•½"""
        summary = {}
        
        for category, info in self.categories.items():
            count = len([etf for etf in self.etf_data.values() 
                        if etf['category'] == category])
            summary[info['name']] = count
        
        return summary
    
    def add_etf(self, code: str, etf_info: Dict) -> bool:
        """ìƒˆë¡œìš´ ETF ì¶”ê°€"""
        try:
            # í•„ìˆ˜ í•„ë“œ ê²€ì¦
            required_fields = ['name', 'category', 'asset_class', 'region']
            for field in required_fields:
                if field not in etf_info:
                    raise ValueError(f"í•„ìˆ˜ í•„ë“œ ëˆ„ë½: {field}")
            
            self.etf_data[code] = etf_info
            logger.info(f"ETF ì¶”ê°€ ì™„ë£Œ: {code} - {etf_info['name']}")
            return True
            
        except Exception as e:
            logger.error(f"ETF ì¶”ê°€ ì‹¤íŒ¨: {e}")
            return False
    
    def update_etf(self, code: str, updates: Dict) -> bool:
        """ETF ì •ë³´ ì—…ë°ì´íŠ¸"""
        try:
            if code not in self.etf_data:
                logger.warning(f"ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ETF ì½”ë“œ: {code}")
                return False
            
            self.etf_data[code].update(updates)
            logger.info(f"ETF ì •ë³´ ì—…ë°ì´íŠ¸: {code}")
            return True
            
        except Exception as e:
            logger.error(f"ETF ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {e}")
            return False
    
    def export_etf_list(self, file_path: str) -> bool:
        """ETF ëª©ë¡ì„ CSVë¡œ ë‚´ë³´ë‚´ê¸°"""
        try:
            etf_list = []
            
            for code, etf_info in self.etf_data.items():
                etf_record = {'code': code}
                etf_record.update(etf_info)
                etf_list.append(etf_record)
            
            df = pd.DataFrame(etf_list)
            df.to_csv(file_path, index=False, encoding='utf-8-sig')
            
            logger.info(f"ETF ëª©ë¡ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ: {file_path}")
            return True
            
        except Exception as e:
            logger.error(f"ETF ëª©ë¡ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: {e}")
            return False
    
    def load_etf_list(self, file_path: str) -> bool:
        """CSVì—ì„œ ETF ëª©ë¡ ê°€ì ¸ì˜¤ê¸°"""
        try:
            df = pd.read_csv(file_path, encoding='utf-8-sig')
            
            for _, row in df.iterrows():
                code = row['code']
                etf_info = row.drop('code').to_dict()
                
                # NaN ê°’ì„ Noneìœ¼ë¡œ ë³€í™˜
                etf_info = {k: (None if pd.isna(v) else v) 
                           for k, v in etf_info.items()}
                
                self.etf_data[code] = etf_info
            
            logger.info(f"ETF ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ: {len(df)}ê°œ")
            return True
            
        except Exception as e:
            logger.error(f"ETF ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: {e}")
            return False
    
    def get_etf_comparison(self, etf_codes: List[str]) -> pd.DataFrame:
        """ETF ë¹„êµ ë¶„ì„"""
        comparison_data = []
        
        for code in etf_codes:
            etf_info = self.etf_data.get(code)
            if etf_info:
                comparison_record = {
                    'ETFì½”ë“œ': code,
                    'ETFëª…': etf_info['name'],
                    'ì¹´í…Œê³ ë¦¬': self.categories[etf_info['category']]['name'],
                    'ìì‚°êµ°': etf_info['asset_class'],
                    'ì§€ì—­': etf_info['region'],
                    'í†µí™”': etf_info.get('currency', 'N/A'),
                    'ë³´ìˆ˜ìœ¨(%)': etf_info.get('expense_ratio', 'N/A'),
                    'ì¶”ì ì§€ìˆ˜': etf_info.get('tracking_index', 'N/A'),
                    'ìš´ìš©ì‚¬': etf_info.get('fund_company', 'N/A'),
                    'í˜„ì¬ê°€': etf_info.get('market_price', 'N/A'),
                    'AUM(ì–µì›)': etf_info.get('aum', 'N/A')
                }
                comparison_data.append(comparison_record)
        
        return pd.DataFrame(comparison_data)
    
    def get_portfolio_allocation_suggestion(self, strategy: str, 
                                          risk_level: str = 'moderate') -> Dict[str, float]:
        """ì „ëµë³„ ìì‚°ë°°ë¶„ ì œì•ˆ"""
        allocations = {
            'conservative': {
                'core_satellite': {'069500': 0.4, '114260': 0.4, '360750': 0.2},
                'global_diversified': {'069500': 0.3, '114260': 0.4, '360750': 0.2, '305080': 0.1},
                'lifecycle': {'069500': 0.3, '114260': 0.5, '329200': 0.2}
            },
            'moderate': {
                'core_satellite': {'069500': 0.3, '360750': 0.4, '114260': 0.2, '229200': 0.1},
                'global_diversified': {'069500': 0.25, '360750': 0.3, '195930': 0.2, '114260': 0.15, '195980': 0.1},
                'lifecycle': {'069500': 0.3, '360750': 0.3, '114260': 0.2, '229200': 0.2}
            },
            'aggressive': {
                'core_satellite': {'360750': 0.4, '069500': 0.25, '229200': 0.2, '133690': 0.15},
                'global_diversified': {'360750': 0.3, '069500': 0.2, '195930': 0.2, '195980': 0.15, '133690': 0.15},
                'lifecycle': {'360750': 0.4, '133690': 0.25, '069500': 0.2, '229200': 0.15}
            }
        }
        
        return allocations.get(risk_level, {}).get(strategy, {})
    
    def get_all_etf_codes(self) -> List[str]:
        """ëª¨ë“  ETF ì½”ë“œ ë°˜í™˜"""
        return list(self.etf_data.keys())
    
    def get_total_market_info(self) -> Dict:
        """ì „ì²´ ì‹œì¥ ì •ë³´ ìš”ì•½"""
        total_aum = sum(etf.get('aum', 0) for etf in self.etf_data.values())
        avg_expense_ratio = sum(etf.get('expense_ratio', 0) for etf in self.etf_data.values()) / len(self.etf_data)
        
        return {
            'total_etfs': len(self.etf_data),
            'total_aum': total_aum,
            'avg_expense_ratio': avg_expense_ratio,
            'categories': len(self.categories),
            'last_updated': datetime.now().isoformat()
        }


# ==========================================
# ì‹¤í–‰ ì˜ˆì œ ë° í…ŒìŠ¤íŠ¸ ì½”ë“œ
# ==========================================

if __name__ == "__main__":
    print("ğŸ“Š ETF ìœ ë‹ˆë²„ìŠ¤ í…ŒìŠ¤íŠ¸")
    print("=" * 60)
    
    # ETF ìœ ë‹ˆë²„ìŠ¤ ì´ˆê¸°í™”
    universe = ETFUniverse()
    
    # ì „ì²´ ì‹œì¥ ì •ë³´
    market_info = universe.get_total_market_info()
    print(f"\nğŸŒ ì „ì²´ ì‹œì¥ ì •ë³´:")
    print(f"- ì´ ETF: {market_info['total_etfs']}ê°œ")
    print(f"- ì´ AUM: {market_info['total_aum']:,.0f}ì–µì›")
    print(f"- í‰ê·  ë³´ìˆ˜ìœ¨: {market_info['avg_expense_ratio']:.3f}%")
    print(f"- ì¹´í…Œê³ ë¦¬: {market_info['categories']}ê°œ")
    
    # ì¹´í…Œê³ ë¦¬ë³„ ìš”ì•½
    print(f"\nğŸ“‹ ì¹´í…Œê³ ë¦¬ë³„ ETF ê°œìˆ˜:")
    category_summary = universe.get_category_summary()
    for category, count in category_summary.items():
        print(f"- {category}: {count}ê°œ")
    
    # ì €ë¹„ìš© ETF ì¡°íšŒ
    print(f"\nğŸ’° ì €ë¹„ìš© ETF (ë³´ìˆ˜ìœ¨ 0.2% ì´í•˜):")
    low_cost_etfs = universe.get_low_cost_etfs(0.2)
    for etf in low_cost_etfs[:5]:
        print(f"- {etf['name']} ({etf['code']}): {etf['expense_ratio']}%")
    
    # ì½”ì–´-ìƒˆí‹€ë¼ì´íŠ¸ ì¶”ì²œ
    print(f"\nğŸ¯ ì½”ì–´-ìƒˆí‹€ë¼ì´íŠ¸ ì „ëµ ì¶”ì²œ:")
    recommendations = universe.get_core_satellite_recommendations()
    
    print(f"ì½”ì–´ ETF:")
    for etf in recommendations['core']:
        print(f"- {etf['name']} ({etf.get('expense_ratio', 'N/A')}%)")
    
    print(f"ìƒˆí‹€ë¼ì´íŠ¸ ETF:")
    for etf in recommendations['satellite']:
        print(f"- {etf['name']} ({etf.get('expense_ratio', 'N/A')}%)")
    
    # ìƒì• ì£¼ê¸°ë³„ ì¶”ì²œ (35ì„¸)
    print(f"\nğŸ”„ ìƒì• ì£¼ê¸° ì „ëµ (35ì„¸):")
    lifecycle_etfs = universe.get_lifecycle_recommendations(35)
    for i, etf in enumerate(lifecycle_etfs, 1):
        print(f"{i}. {etf['name']} - {etf['description'][:50]}...")
    
    # ETF ë¹„êµ
    print(f"\nâš–ï¸ ì£¼ìš” ETF ë¹„êµ:")
    comparison_codes = ['069500', '360750', '114260']
    comparison_df = universe.get_etf_comparison(comparison_codes)
    print(comparison_df.to_string(index=False))
    
    print(f"\nâœ… ETF ìœ ë‹ˆë²„ìŠ¤ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")
    print(f"ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„:")
    print(f"   - python data/database_manager.py : ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ í…ŒìŠ¤íŠ¸")
    print(f"   - python core/portfolio_manager.py : í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬ í…ŒìŠ¤íŠ¸")